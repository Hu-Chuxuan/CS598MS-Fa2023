SELECT * FROM (SELECT DISTINCT (CONCAT('IF(', tconst, ', THEN ', numVotes, '/', numVotes + AVG(numVotes), ') > 0.2 AND ', CONCAT('CASE WHEN ', nconst, '.job = \'', category, "\'' THEN ', CONCAT('\"', nconst, ".", CONCAT("[", category, "\']") ) ELSE ', NULL END'),') THEN ', IF(rating >= 5, 1, 0)) AS r_score', tconst, ', ', nconst,'WHERE ', tconst,'IS NOT NULL GROUP BY tconst, nconst HAVING COUNT(*) > 1 ORDER BY SUM(r_score*numVotes)/COUNT(*)+SUM((IF(rating>=5,1,0)*numVotes)/count(*) DESC LIMIT 10) ASC) as f FROM (SELECT DISTINCT ('IF(', tconst, ', THEN ', numVotes, '/', numVotes + AVG(numVotes), ') > 0.2 AND ', CONCAT('CASE WHEN ', nconst, '.job = \'', category, "\'" THEN ', CONCAT('\"', nconst, ".", CONCAT("[", category, "\']") ),' ELSE ', CONCAT('NULL'),'\' END'),') THEN ', IF(rating >= 5, 1, 0)) AS r_score', tconst, ', ', nconst,'WHERE ', tconst,'IS NOT NULL GROUP BY tconst, nconst HAVING COUNT(*)>1 ORDER BY sum(r_score*numvotes)/count(*)+sum(if(rating>=5,1,0)*numvotes)/count(*) limit 10 asc) as f from (SELECT distinct ('If', tconst,'Then ', numvotes, '/', numvotes + avg(numvotes), ')', tconst, '', nconst, '', 'Job = ''', category, ''\'', nconst, ''. ''concat('"', nconst, '"', concat("[",category,"]"')), '' Else 'NULL End', ''), tconst, ', ', nconst,'where tconst not null group by tconst, nconst having count(*)>1 order by sum(r_scoresum*numvotes)/count(*)+sum(if(rating>=5