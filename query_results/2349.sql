SELECT t.* FROM (SELECT t.startYear AS StartYear, t.endYear As EndYear, SUM((CASE WHEN rating IS NULL THEN 0 ELSE 1 END)*numvotes)/SUM(CASE WHEN rating IS NOT NULL THEN 1 ELSE 0 END*numvotes)) AS avgrating, t.* FROM title_basics WHERE ((primaryTitle LIKE '%' ||? || '%') AND (isAdult = 0 OR isAdult > 0 )AND ((StartYear <=? && EndYear >=?) OR (EndYear <? && StartYear>?))) GROUP BY t.titleId ORDER BY avgratng DESC LIMIT 5